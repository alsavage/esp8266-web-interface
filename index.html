<!doctype html>
<html>
<head>
<!--
 * This file is part of the esp8266 web interface
 *
 * Copyright (C) 2018 Johannes Huebner <dev@johanneshuebner.com>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
-->
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Huebner Inverter Management Console</title>
<link href="style.css" rel="stylesheet" type="text/css" />
<script src="chart.min.js" type="text/javascript"></script>
<script src="inverter.js" type="text/javascript"></script>
<script src="index.js" type="text/javascript"></script>
<script src="subscription.js" type="text/javascript"></script>
<!-- <script src="log.js" type="text/javascript"></script> -->
</head>

<body onload="onLoad()">

	<div id="content">

		<div class="navbar">
			<div id="logo">
			    <img src="logo.png">
		    </div>

		    <a class="tablink" onclick="openPage('dashboard', this, 'white')" style="background-color:white">
		    	<img class="buttonimg" src="/icons/grid.svg">DASHBOARD</a>
	        <!--<a class="tablink" onclick="openPage('commands', this, 'white')">
	        	<img class="buttonimg" src="/icons/terminal.svg">COMMANDS</a>-->
		    <a class="tablink" onclick="openPage('update', this, 'white')">
		    	<img class="buttonimg" src="/icons/cpu.svg">UPDATE</a>
		    <a class="tablink" onclick="openPage('parameters', this, 'white')">
		    	<img class="buttonimg" src="/icons/sliders.svg">PARAMETERS</a>
			<a class="tablink" onclick="openPage('spotvalues', this, 'white')">
				<img class="buttonimg" src="/icons/target.svg">SPOT VALUES</a>
			<a class="tablink" onclick="openPage('plot', this, 'white')">
				<img class="buttonimg" src="/icons/activity.svg">PLOT</a>
			<a class="tablink" onclick="openPage('logger', this, 'white')">
				<img class="buttonimg" src="/icons/database.svg">DATA LOGGER</a>
			<a class="tablink" onclick="openPage('canmapping', this, 'white')">
				<img class="buttonimg" src="/icons/repeat.svg">CAN MAPPING</a>
			<a class="tablink" onclick="openPage('wifi', this, 'white')">
				<img class="buttonimg" src="/icons/wifi.svg">WIFI SETTINGS</a>
			<a class="tablink" href="/support">
				<img class="buttonimg" src="/icons/help-circle.svg">SUPPORT</a>

			<br><br>
			<a class="tablink" href="javascript:updateTables()"><img src="refresh.png" style="margin-top: -1em; margin-bottom: -8px; margin-right: 0.5em">Refresh</a>
			<div style="float:left">
			    <input type="checkbox" title="Keep refreshing until unchecked" id="autorefresh"><label for="autorefresh">Auto</label>
			</div>

			<div id="version">
				<p>Firmware : v5.0.1</p>
				<p>Web UI : v2.0</p>
			</div>

		</div>

		<!-- DASHBOARD -->
		<div id="dashboard" class="tabdiv main-content" style="display:flex;">
			<div class="main-right">
				<h3>Actions</h3>
				<button onclick="sendCmd('start 2');">
		    	<img class="buttonimg" src="/icons/play.svg">Start Inverter in manual Mode</button>
		        <button onclick="sendCmd('stop');">
		    	<img class="buttonimg" src="/icons/square.svg">Stop Inverter</button>
		    	<button onclick="sendCmd('errors');">Display Error Memory</button>
		        <p><input type="text" id="customcmd"/> <button onclick="sendCmd(document.getElementById('customcmd').value);">Send Custom Command</button></p>
		        <!-- <p><a href="/remote.html">Start Remote Support Session</a></p> -->
		    </div>
            
            <div class="main-left">
				<h2>Dashboard</h2>
				<div id="top-row">
                    <div id="top-left">
                    	<p>Inverter status : WaitStart</p>
                    	<p>Last error : None</p
                    	<p>Battery voltage (udc) : 351v</p>
                    </div>
                    <div id="top-right">
						<h3>Inverter messages</h3>
						<pre><div id="message"></div></pre>
						<!-- <button onclick="clearMessages();">Clear</button>-->
					</div>
				</div>
				<div id="bottom-row">
                    <div id="bottom-left">
                    	bottom-left
                    </div>
                    <div id="bottom-right">
					    bottom-right
					</div>
				</div>
				
				
		    </div>
		</div>

	    <!-- UPDATE -->
		<div id="update" class="tabdiv main-content">

			<div class="main-right">
				<h3>Actions</h3>
                <a href="/swd/zero" target="_blank"><button>
                	<img class="buttonimg" src="/icons/trash-2.svg">Erase Flash</button></a>
                <a href="#" onclick="resetSWD();"><button>
                	<img class="buttonimg" src="/icons/rotate-ccw.svg">Hard Reset</button></a>
                <a href="/swd/bin?bootloader"><button>
                	<img class="buttonimg" src="/icons/download.svg">Download Bootloader</button></a>
                <a href="/swd/bin?flash"><button>
                	<img class="buttonimg" src="/icons/download.svg">Download Flash</button></a>
			</div>

			<div class="main-left">
			    <h2 id="update">UART Update</h2>
			    <p>Use binary files (stm32_sine/foc.bin) for updating inverter firmware. Upload any other file for updating this web interface.</p>
			    <form id="uploadform" enctype="multipart/form-data" action="edit" method="POST">
			        <input id="updatefile" name="updatefile" type="file" onchange="fileSelected();" />
			        <input type="button" onclick="uploadFile();" value="Upload" />
			    </form>
			    <div id="progress" class="graph">
			        <div id="bar" style="width: 0"></div>
			    </div>

			    <h2 id="swdupdate">SWD Update</h2>
			    <p>Use binary files (stm32_loader.bin, stm32_sine/foc.bin) for updating inverter bootloader/firmware.</p>
			    <form id="swdform" enctype="multipart/form-data" action="edit" method="POST">
			        <input id="swdfile" name="swdfile" type="file" onchange="fileSelected();" accept=".bin" />
			        <input type="button" onclick="uploadSWDFile();" value="Upload" />
			    </form>
			    <div id="progress" class="graph">
			    <div id="swdbar" style="width: 0"></div>
			    </div>
			    <br/><br/>
			    
			</div>
		</div>

	    <!-- PARAMETERS -->
		<div id="parameters" class="tabdiv main-content">

			<div class="main-right">
				<h3>Save & load</h3>
				<button onclick="sendCmd('save');">
					<img class="buttonimg" src="/icons/save.svg">Save Parameters to Flash</button>
			    <button onclick="sendCmd('load');">
			    	<img class="buttonimg" src="/icons/rotate-ccw.svg">Restore Parameters from Flash</button>
			    <form id="paramdb" action="https://openinverter.org/parameters/api.php" method="POST" enctype="multipart/form-data">
			        <input type="text" style="display: none;" id="parameters_json" name="data"></input>
			        <input type="hidden" id="parameters_token" name="token" />
			        <button onclick="parameterSubmit();"><image class="buttonimg" src="/icons/upload-cloud.svg"> Submit Parameters to Openinverter</button>
			    </form>

			    <a download="params.json" href="data:text/json,{ }" id="paramDownload"><button>
			    	<img class="buttonimg" src="/icons/download.svg"> Download Parameter File</button></a>

			    <a href="https://openinverter.org/wiki/Parameters" target="_blank"><button>
			    	<img class="buttonimg" src="/icons/help-circle.svg">Parameter Reference</button></a>

                <hr>
                <h3>Load Parameters from file</h3>
			    <form id="paramform" enctype="multipart/form-data" action="edit" method="POST">
			        <input id="paramfile" name="paramfile" type="file" hidden />
			        <input type="button" onclick="loadParametersFromFile();" value="Apply Parameter File" />
			        <label for="paramfile">Load Parameters from File</label>
			    </form>
			    
			    <hr>			    
			    
			    <h3>Subscribe to parameter set</h3>
			    <input id="token" type="text" onchange="checkToken(this.value, 'Requesting parameter set', true)" size="40">
			    
			    <h3>asdf</h3>
			    <p><img src="ajax-loader.gif" style="visibility: hidden" id="loader1">
			    <button onclick="toggleVisibility();">Toggle Category Visibility</button></p>
			    <p>
			</div>

			<div class="main-left">
			    <table id="params">
			    <thead>
			        <tr>
			            <th>I</th>
			            <th>Name</th>
			            <th>Value</th>
			            <th>Unit</th>
			            <th>Minimum</th>
			            <th>Maximum</th>
			            <th>Default</th>
			        </tr>
			    </thead>
			    <tbody id="paramBody">
			    </tbody>
			    </table>
			</div>

		</div>

	    <!-- SPOT VALUES -->
		<div id="spotvalues" class="tabdiv main-content">

			<div class="main-right">
			    <button onclick="showGauges()">Show Gauges</button>
		        <button onclick="showLog()">Show Data Logger</button>
		        <button onclick="sendCmd('can clear');">Reset CAN Mapping</button>
		    </div>

            <div class="main-left">
			    <h2 id="spot">Spot Values</h2>
			    <p><img src="ajax-loader.gif" style="visibility: hidden" id="loader2">
			    <table id="spotValues">
			        <thead>
			            <tr>
			                <th>Name</th>
			                <th>Value</th>
			                <th>Unit</th>
			                <th>Plot</th>
			                <th>CAN Id</th>
			                <th>Position</th>
			                <th>Bits</th>
			                <th>Gain</th>
			                <th>Map to CAN</th>
			            </tr>
			        </thead>
			        <tbody id="spotBody">
			        </tbody>
			    </table>
			</div>

		</div>

	    <!-- PLOT -->
		<div id="plot" class="tabdiv main-content">
			<div class="main-right">
                <button onclick="startPlot()">
                	<img class="buttonimg" src="/icons/play.svg">Start Plot</button>
			    <button onclick="stopPlot()">
			    	<img class="buttonimg" src="/icons/square.svg">Stop Plot</button>
			    <button onclick="pauseResumePlot()" disabled id="pauseButton">
			    	<img class="buttonimg" src="/icons/pause.svg">Pause Plot</button>
			</div>

			<div class="main-left">
				<h2 id="plot">Plot</h2>
			    <canvas id="canvas" width=100 height=40></canvas>
			    <p>
			    
			    Limit data points to: <input type="number" id="maxValues" step="1" min="10" max="10000" value="1000" />
			    Burst length: <input type="number" id="burstLength" step="1" min="1" max="1000" value="10" />
			    <p>Copyright 2018 Johannes Huebner dev@johanneshuebner.com</p>
			    <p>Charting by <a href="http://chartjs.org/" target="_blank">chart.js</a></p>
			    <p>Gauges by <a href="https://github.com/Mikhus/canvas-gauges" target="_blank">Mykhailo Stadnyk</a></p>
			</div>

		    
		</div>

		<!-- DATA LOGGER -->
		<div id="logger" class="tabdiv main-content">
			<div class="main-right">
                <label for="samples">Samples per line: </label>
				<input id="samples" type="number" step="1" min="1" max="2000" value="500">
				<input type="checkbox" id="minmax">
				<label for="minmax">Include Min/Max values</label>
				<button onclick="start()" id="startstop">Start/Stop logging</button>
				<button onclick="save()">Save As...</button>
			</div>

			<div class="main-left">
				<textarea id="textArea" rows="50" style="display:block; width: 100%;">
				</textarea>
			</div>
		</div>

		<!-- CAN MAPPING -->
		<div id="canmapping" class="tabdiv main-content">
			<div class="main-right">
			</div>
			<div class="main-left">
				<h2>CAN Mapping</h2>
				<p>On this page you can configure the CAN mapping settings for your OpenInverter board. CAN mapping allows you to send and receive data via CAN bus. You can specify spot values that you would like to transmit on the CAN bus. Additionally you can specify spot values that you would like to set based on data received on the CAN bus.</p>
				<div id="addcanmapping">
					<h3>New CAN Mapping</h3>
					<form>
						<table id="canmapping">
							<tr>
								<td>Transmit or receive</td>
								<td>
								    <select id="txrx">
						    			<option value="tx">Transmit</option>
							    		<option value="rx">Receive</option>
							    	</select>
							    </td>
							    <td>Choose transmit to take spot values from your OpenInverter board and send them out in frames on the CAN bus where they can be seen by other devices. Choose receive to set spot values based on data seen on the CAN bus.</td>
							</tr>
							<tr>
								<td>Spot value</td>
								<td>
									<select id="addCanMappingSpotValueDropDown"></select>
								</td>
								<td>Select the spot value transmit or receive.</td>
							</tr>
						    <tr>
						    	<td>CAN ID</td>
						    	<td><input type="number" step="1" min="0" max="2047" id="canid"></td>
						    	<td>Set the ID of the CAN frame to send/recieve</td>
						    </tr>
		    				<tr>
		    					<td>Position</td>
		    					<td><input type="number" step="1" min="0" max="63" id="canpos"></td>
		    					<td>Specify the position (offset) within the frame to place (transmit) or find (receive) this value</td>
		    				</tr>
			    			<tr>
			    				<td>Bits</td>
			    				<td><input type="number" step="1" min="1" max="32" id="canbits"></td>
			    				<td>Specify the lenth of this field in bits</td>
			    			</tr>
				    		<tr>
				    			<td>Gain</td>
				    			<td><input type="number" step="1" min="1" max="100" id="cangain"></td>
				    			<td>Specify a gain to scale the value up or down</td>
				    		</tr>
					    </table>
					</form>
				</div>
				<button onclick="document.getElementById('addcanmapping').style.display='block';">
					<img class="buttonimg" src="/icons/plus-circle.svg">Add a new CAN mapping</button>
			</div>
		</div>


		<!-- WIFI SETTINGS -->
		<div id="wifi" class="tabdiv main-content">
			<div class="main-right">
			</div>
			<div class="main-left">
				<h2>WiFi Settings</h2>
				<h3>Access Point Settings</h3>
                <p>Here you can specify SSID and password of the access point that is created by the inverter.</p>
                <form id="apform" enctype="multipart/form-data" action="wifi" method="POST">
                    <p><label for="apSSID">AP SSID: </label><input id="apSSID" name="apSSID" type="text" value="%apSSID%"/>
                    <p><label for="apPW">AP WPA2 Password: </label><input id="apPW" name="apPW" type="text" title="Must be at leat 8 characters long" onkeyup="onAPPW(this.value)"/><br>
                    <p><input id="apsubmit" type="submit" value="Modify" disabled/>
                </form>
                <hr>
                <h3>Station Settings</3>
                <p>Here you can specify a Wifi network that the inverter joins.</p>
                <form id="apform" enctype="multipart/form-data" action="wifi" method="POST">
                    <p><label for="staSSID">Network SSID: </label><input id="staSSID" name="staSSID" type="text" value="%staSSID%"/>
                    <p><label for="staPW">WPA2 Password: </label><input id="staPW" name="staPW" type="text" />
                    <p>Current IP Address: %staIP%
                    <p><input type="submit" value="Modify" />
                </form>
			</div>
		</div>

</div>

</body>
</html>

